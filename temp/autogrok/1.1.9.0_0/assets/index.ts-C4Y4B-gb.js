let e="/",n="";const t=new Map,a=async()=>{if(chrome.sidePanel)try{await chrome.sidePanel.setOptions({path:"src/ui/side-panel/index.html",enabled:!0}),await chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0})}catch(e){}};a();const o=async e=>{try{const n=await chrome.tabs.query({url:[`*://kylenguyen.me/*?${e}`]});if(n.length>0&&"number"==typeof n[0].id){const e=n[0];"number"==typeof e.windowId&&await chrome.windows.update(e.windowId,{focused:!0}),await chrome.tabs.update(e.id,{active:!0})}else await chrome.tabs.create({url:`https://kylenguyen.me?${e}`})}catch(n){}};chrome.runtime.onInstalled.addListener(async e=>{await a(),"install"===e.reason?(await o("?new-version-installed=true"),await(async()=>{try{const n=await chrome.tabs.query({url:["*://grok.com/*"]});for(const t of n)if(t.id)try{await chrome.tabs.reload(t.id)}catch(e){}n.length}catch(e){}})()):"update"===e.reason&&await o("?new-version-updated=true")}),self.onerror=function(e,n,t,a,o){},chrome.action.onClicked.addListener(async e=>{if(chrome.sidePanel&&void 0!==e.id)try{await chrome.sidePanel.open({tabId:e.id})}catch(n){}}),chrome.runtime.onMessage.addListener((a,o,i)=>{switch(a.type){case"SET_ZOOM":{const{zoomFactor:e}=a;o.tab?.id?(chrome.tabs.setZoom(o.tab.id,e),i({success:!0})):i({success:!1,error:"Tab ID not found"})}break;case"DOWNLOAD_IMAGE":{const{url:n,filename:o}=a,r=`${e}${o}`;return t.set(n,r),chrome.downloads.download({url:n,filename:r,saveAs:!1},e=>{const n=chrome.runtime?.lastError;i(!n&&e?{success:!0,downloadId:e}:{success:!1,error:n?.message||"Failed to start download"})}),!0}case"SETUP_DOWNLOAD":{const{folder:t,prefix:o}=a;"string"==typeof t&&(e=t.trim()?`${t.trim()}/`:"/"),"string"==typeof o&&(n=o.trim()),i({success:!0})}}return!1});const i=(a,o)=>{if(a.byExtensionId&&a.byExtensionId!==chrome.runtime.id)return;const i=/\.(mp4)$/i.test(a.filename||a.url),r=/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(a.filename||a.url);if(!i&&!r)return;if(t.has(a.url)){return o({filename:t.get(a.url)}),void t.delete(a.url)}const s=a.filename,c=s.split("/").pop()||s;o({filename:`${e}${n}${c}`})},r=new Set;chrome.runtime.onConnect.addListener(e=>{"side-panel"===e.name&&(r.add(e),1!==r.size||chrome.downloads.onDeterminingFilename.hasListener(i)||chrome.downloads.onDeterminingFilename.addListener(i),e.onDisconnect.addListener(()=>{r.delete(e),0===r.size&&chrome.downloads.onDeterminingFilename.hasListener(i)&&chrome.downloads.onDeterminingFilename.removeListener(i)}))});
